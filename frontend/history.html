<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Move History | FEC Online</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="history.css">
</head>

<body>
    <div class="dashboard-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <span class="material-icons-round">dashboard</span>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item" title="Home">
                    <span class="material-icons-round">home</span>
                </a>
                <a href="operation.html" class="nav-item" title="Operations">
                    <span class="material-icons-round">settings_suggest</span>
                </a>
                <a href="stock.html" class="nav-item" title="Stock">
                    <span class="material-icons-round">inventory_2</span>
                </a>
                <a href="history.html" class="nav-item active" title="Move History">
                    <span class="material-icons-round">history</span>
                </a>
                <a href="#" class="nav-item" title="Settings">
                    <span class="material-icons-round">settings</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Header -->
            <header class="top-bar">
                <div class="page-title">Move History</div>
                <div class="user-account">
                    <span class="material-icons-round">account_circle</span>
                </div>
            </header>

            <!-- Content Container -->
            <section class="content-container">
                <!-- Controls Bar -->
                <div class="controls-bar">
                    <div class="left-controls">
                        <button class="btn-new">NEW</button>
                    </div>
                    <div class="right-controls">
                        <div class="search-box">
                            <span class="material-icons-round">search</span>
                        </div>
                        <button class="icon-btn"><span class="material-icons-round">format_list_bulleted</span></button>
                        <button class="icon-btn"><span class="material-icons-round">view_kanban</span></button>
                    </div>
                </div>

                <!-- Table Widget -->
                <div class="table-widget">
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Reference</th>
                                    <th>Date</th>
                                    <th>Contact</th>
                                    <th>From</th>
                                    <th>To</th>
                                    <th>Quantity</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>
    <script src="api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const tableBody = document.getElementById('history-table-body');

            try {
                // Fetch all movement types in parallel
                const [receipts, deliveries, transfers] = await Promise.all([
                    api.getReceipts(),
                    api.getDeliveries(),
                    api.getTransfers()
                ]);

                let allMoves = [];

                // Normalize Receipts
                if (receipts && receipts.results) {
                    allMoves = allMoves.concat(receipts.results.map(item => ({
                        type: 'move-in',
                        ref: item.document_number,
                        date: item.date,
                        contact: item.vendor_details ? item.vendor_details.name : '-',
                        from: 'Vendor',
                        to: item.items[0] ? item.items[0].location_details.name : '-',
                        qty: item.items.reduce((sum, i) => sum + i.quantity, 0),
                        status: item.status
                    })));
                }

                // Normalize Deliveries
                if (deliveries && deliveries.results) {
                    allMoves = allMoves.concat(deliveries.results.map(item => ({
                        type: 'move-out',
                        ref: item.document_number,
                        date: item.date,
                        contact: item.customer,
                        from: item.items[0] ? item.items[0].location_details.name : '-',
                        to: 'Customer',
                        qty: item.items.reduce((sum, i) => sum + i.quantity, 0),
                        status: item.status
                    })));
                }

                // Normalize Transfers
                if (transfers && transfers.results) {
                    allMoves = allMoves.concat(transfers.results.map(item => ({
                        type: 'move-out', // Or neutral
                        ref: item.document_number,
                        date: item.date,
                        contact: '-',
                        from: item.source_location_details ? item.source_location_details.name : '-',
                        to: item.destination_location_details ? item.destination_location_details.name : '-',
                        qty: item.items.reduce((sum, i) => sum + i.quantity, 0),
                        status: item.status
                    })));
                }

                // Sort by date descending (assuming date string is ISO or sortable)
                allMoves.sort((a, b) => new Date(b.date) - new Date(a.date));

                tableBody.innerHTML = '';
                allMoves.forEach(move => {
                    const row = document.createElement('tr');
                    row.className = move.type;
                    row.innerHTML = `
                        <td>${move.ref}</td>
                        <td>${move.date}</td>
                        <td>${move.contact}</td>
                        <td>${move.from}</td>
                        <td>${move.to}</td>
                        <td>${move.qty}</td>
                        <td>${move.status}</td>
                    `;
                    tableBody.appendChild(row);
                });

            } catch (error) {
                console.error('Failed to load history', error);
                tableBody.innerHTML = '<tr><td colspan="7">Failed to load data</td></tr>';
            }
        });
    </script>
</body>

</html>